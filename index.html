<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>PRIT_ORDPACK_ONE – סינון לפי תאריך יעד (DUEDATE)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: Arial, sans-serif; max-width: 1100px; margin: 24px auto; padding: 0 12px; }
    h1 { margin: 0 0 12px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    label { display: flex; gap: 6px; align-items: center; font-weight: 600; }
    input[type="date"] { padding: 8px; font: inherit; }
    button { padding: 8px 14px; font: inherit; cursor: pointer; }
    code { background: #f3f3f3; padding: 2px 6px; border-radius: 6px; }
    #status { margin: 4px 0 8px; min-height: 1.2em; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: right; vertical-align: top; }
    thead th { position: sticky; top: 0; background: #f6f6f6; z-index: 1; }
    .muted { color: #666; font-size: .9em; }
  </style>
</head>
<body>
  <h1>PRIT_ORDPACK_ONE – סינון לפי תאריך יעד (DUEDATE)</h1>

  <div class="row">
    <label>תאריך: <input id="date" type="date"></label>
    <button id="btn-today" type="button">היום</button>
    <button id="btn-run" type="button">שלוף</button>
    <button id="btn-export" type="button" disabled>ייצוא CSV</button>
    <span class="muted">קריאה: <code id="dbg-url">/api/PRIT_ORDPACK_ONE?...</code></span>
  </div>

  <div id="status"></div>
  <div id="results"></div>

  <script>
    // ===== הגדרות כלליות ==========================================
    const ENTITY = "PRIT_ORDPACK_ONE";
    let lastRows = [];
    let lastCols = [];

    // פותח Session לקבלת עוגיית HttpOnly מהשרת ( /api/session )
    async function ensureSession() {
      // נקרא פעם אחת בתחילת השימוש; אפשר לקרוא גם אם כבר קיים — לא מזיק.
      await fetch("/api/session", { method: "POST", credentials: "include" }).catch(()=>{});
    }

    // עטיפת fetch ששולחת את העוגייה עם כל קריאה ל-API
    async function myFetch(url) {
      return fetch(url, { credentials: "include" });
    }

    // ===== עזרי UI/תאריכים =========================================
    function todayStr() {
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${d.getFullYear()}-${mm}-${dd}`;
    }
    function buildFilterFromDate(yyyyMmDd) {
      // Priority מצפה ל-ISO מלא: YYYY-MM-DDT00:00:00Z
      return `DUEDATE eq ${yyyyMmDd}T00:00:00Z`;
    }
    function setDebugUrl(url) {
      document.getElementById("dbg-url").textContent =
        url.length > 90 ? url.slice(0,87) + "..." : url;
    }

    // === OData paging: המרה של nextLink לנתיב ה-proxy =================
    function toProxyNextLink(entity, nextLink) {
      const u = new URL(nextLink);
      return `/api/${encodeURIComponent(entity)}${u.search}`;
    }

    // אוסף *את כל* הדפים עד שאין @odata.nextLink
    async function fetchAllPages(entity, firstUrl) {
      await ensureSession(); // חשוב: לבקש עוגייה לפני הבקשה הראשונה
      let url = firstUrl;
      const all = [];
      for (let i = 0; i < 200 && url; i++) { // בלם בטיחות
        const res = await myFetch(url);
        if (!res.ok) {
          const text = await res.text().catch(()=> "");
          throw new Error(`HTTP ${res.status}${text ? " – " + text.slice(0,300) : ""}`);
        }
        const data = await res.json();
        const page = Array.isArray(data.value) ? data.value : [];
        all.push(...page);
        url = data['@odata.nextLink'] ? toProxyNextLink(entity, data['@odata.nextLink']) : null;
      }
      return all;
    }

    // ===== טבלה וייצוא ==============================================
    function computeColumns(rows) {
      const set = new Set();
      for (const r of rows) for (const k of Object.keys(r)) set.add(k);
      const preferred = ["ORDNAME","DUEDATE","CUSTNAME","BRANCHCODE"];
      const cols = [];
      for (const p of preferred) if (set.has(p)) { cols.push(p); set.delete(p); }
      return cols.concat([...set]);
    }

    function renderTable(rows) {
      const results = document.getElementById("results");
      results.innerHTML = "";
      if (!rows.length) {
        results.textContent = "אין נתונים לתאריך שבחרת.";
        lastRows = []; lastCols = [];
        document.getElementById("btn-export").disabled = true;
        return;
      }
      const cols = computeColumns(rows);
      lastRows = rows; lastCols = cols;
      document.getElementById("btn-export").disabled = false;

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const trh = document.createElement("tr");
      for (const c of cols) { const th = document.createElement("th"); th.textContent = c; trh.appendChild(th); }
      thead.appendChild(trh); table.appendChild(thead);

      const tbody = document.createElement("tbody");
      for (const r of rows) {
        const tr = document.createElement("tr");
        for (const c of cols) {
          const td = document.createElement("td");
          const v = r[c];
          td.textContent = (v === null || v === undefined) ? "" : (typeof v === "object" ? JSON.stringify(v) : String(v));
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      results.appendChild(table);
    }

    function toCSV(rows, cols) {
      const esc = (s) => {
        if (s == null) return "";
        const t = String(s).replace(/"/g, '""');
        return /[",\n]/.test(t) ? `"${t}"` : t;
      };
      const header = cols.map(esc).join(",");
      const lines = rows.map(r => cols.map(c => {
        const v = r[c];
        return esc(typeof v === "object" && v !== null ? JSON.stringify(v) : v);
      }).join(","));
      return [header, ...lines].join("\n");
    }
    function downloadCSV(filename) {
      if (!lastRows.length) return;
      const csv = toCSV(lastRows, lastCols);
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      URL.revokeObjectURL(url); a.remove();
    }

    // ===== זרימת החיפוש ==============================================
    async function runQuery() {
      const status = document.getElementById("status");
      const dateVal = document.getElementById("date").value; // YYYY-MM-DD
      if (!dateVal) { status.textContent = "בחר/י תאריך קודם."; return; }

      const filter = buildFilterFromDate(dateVal);
      const firstUrl = `/api/${ENTITY}?$filter=${encodeURIComponent(filter)}`;
      setDebugUrl(firstUrl);

      status.textContent = "טוען... (אוסף עמודים)";
      try {
        const rows = await fetchAllPages(ENTITY, firstUrl);
        status.textContent = `נמצאו ${rows.length} רשומות.`;
        renderTable(rows);
      } catch (e) {
        status.textContent = "שגיאה: " + (e.message || e);
        document.getElementById("results").innerHTML = "";
        document.getElementById("btn-export").disabled = true;
      }
    }

    // ===== אירועים ואתחול ============================================
    document.getElementById("btn-today").addEventListener("click", () => {
      document.getElementById("date").value = todayStr();
    });
    document.getElementById("btn-run").addEventListener("click", runQuery);
    document.getElementById("btn-export").addEventListener("click", () => {
      const d = document.getElementById("date").value || todayStr();
      downloadCSV(`PRIT_ORDPACK_ONE_${d}.csv`);
    });
    document.getElementById("date").addEventListener("keydown", (e) => {
      if (e.key === "Enter") runQuery();
    });

    // ערך ברירת מחדל: היום
    document.getElementById("date").value = todayStr();
  </script>
</body>
</html>
